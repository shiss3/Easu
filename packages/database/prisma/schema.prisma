// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// packages/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 1. Hotel 表
model Hotel {
  id      Int    @id @default(autoincrement())
  name    String // 名称
  address String // 地址
  city    String // 城市

  latitude  Float? // 经度
  longitude Float? // 纬度

  coverImage  String // 封面
  images      String[] // 酒店外观图等
  description String? // 描述

  tags      String[] // 标签 ['免费停车', '智能客控']
  priceDesc String? // 价格描述 '特惠一口价'

  status    Int @default(1) // 1: 正常, 0: 下架
  sortOrder Int @default(0) // 优先级，越小越高

  score       Float @default(5.0)
  reviewCount Int   @default(0)

  roomTypes RoomType[]
  homeBanners HomeBanner[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, status])
}

// 首页 Banner 广告投放表
model HomeBanner {
  id Int @id @default(autoincrement())

  // 投放城市，为空代表“全国通投”
  targetCity String?

  // 关联酒店
  hotelId Int
  hotel   Hotel @relation(fields: [hotelId], references: [id])

  // 营销信息
  title            String?
  subTitle         String?
  imageUrlOverride String?

  // 1: 上线, 0: 下架
  status Int @default(1)

  // 排序权重，越小越靠前
  sortOrder Int @default(0)

  // 投放有效期（为空代表不限制）
  startAt DateTime?
  endAt   DateTime?

  // 统计与活动
  trackCode  String?
  campaignId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([targetCity, status, sortOrder])
  @@index([hotelId])
}

// 2. RoomType 表
model RoomType {
  id Int @id @default(autoincrement())

  hotelId Int
  hotel   Hotel @relation(fields: [hotelId], references: [id])

  name        String // 房型名称
  price       Int // 基础刊例价 (单位：分，建议用整数存储金额)
  bedInfo     String // 床铺信息
  images      String[] // 房型相册
  salesVolume Int      @default(0) // 销量
  sortOrder   Int      @default(0) // 排序

  capacity        Int     @default(2) // 最大容纳人数
  hasWindow       Boolean @default(false)
  hasBreakfast    Boolean @default(false)
  childrenFriendly Boolean @default(false)
  tags            String[] // 房型特性标签，如 "双窗房", "智能马桶"

  inventories RoomInventory[]

  @@index([hotelId])
}

// 3. RoomInventory 表 (补全以保证关联关系成立)
model RoomInventory {
  id Int @id @default(autoincrement())

  roomTypeId Int
  roomType   RoomType @relation(fields: [roomTypeId], references: [id])

  date  DateTime // 具体日期
  price Int? // 当日特殊价格，为空则使用RoomType基础价
  quota Int      @default(10) // 当日库存

  @@unique([roomTypeId, date]) // 同一种房型在同一天只能有一条库存记录
  @@index([date, quota])
}

model User {
  id       Int     @id @default(autoincrement())
  phone    String  @unique // 核心登录账号
  password String? // 密码 (加密存储)，验证码登录时可能为空
  name     String?
  avatar   String?
  role     String  @default("USER") // 'USER' | 'ADMIN'

  // 安全字段
  failedLoginAttempts Int       @default(0) // 连续登录失败次数
  lockoutUntil        DateTime? // 账号锁定截止时间

  // 关联
  tokens UserToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// UserToken 模型：支持多端登录与 Refresh Token 管理
model UserToken {
  id        Int      @id @default(autoincrement())
  token     String // 存储 RefreshToken，不建议索引，仅用于比对
  device    String? // 设备标识，如 "iPhone 14", "PC-Chrome"
  expiresAt DateTime // 物理过期时间

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // 索引：为了加快 refreshToken 验证速度，可以给 token 加索引，
  // 但考虑到 token 较长，有些 DB 限制索引长度。
  // 也可以仅索引 userId，通过 userId + token 查找。
  @@index([userId])
}
