// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// packages/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL") // 从环境变量读取
}

// 枚举：酒店审核进度
enum ReviewProcess {
  PENDING // 审核中
  PUBLISHED // 已发布（前端可见）
  REJECTED // 已拒绝
  DRAFT // 草稿（商户暂存，不提交审核）
}

// 1. HotelList 表
model Hotel {
  id      Int    @id @default(autoincrement())
  name    String // 名称
  address String // 地址
  city    String // 城市

  star Int @default(0) // 星级（0:无星级，2-5分别对应相应星级

  latitude  Float? // 经度
  longitude Float? // 纬度

  coverImage  String // 封面
  images      String[] // 酒店外观图等
  description String? // 描述

  tags      String[] // 标签 ['免费停车', '智能客控']
  priceDesc String? // 价格描述 '特惠一口价'

  status    Int @default(1) // 1: 正常, 0: 下架
  sortOrder Int @default(0) // 优先级，越小越高

  score       Float @default(5.0)
  reviewCount Int   @default(0)

  roomTypes   RoomType[]
  homeBanners HomeBanner[]

  // b端新增字段
  checking  ReviewProcess @default(PENDING) // 审核进度
  adminNote String?       @db.VarChar(255) // 管理员填写的审核意见（如不通过原因
  // 关联商户
  ownerId   Int?          @default(1) // 为了数据库现存数据，暂时可选不添加（开发ing）
  owner     Manager?      @relation("MerchantHotels", fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, status, checking])
}

// 首页 Banner 广告投放表
model HomeBanner {
  id Int @id @default(autoincrement())

  // 投放城市，为空代表“全国通投”
  targetCity String?

  // 关联酒店
  hotelId Int
  hotel   Hotel @relation(fields: [hotelId], references: [id])

  // 营销信息
  title            String?
  subTitle         String?
  imageUrlOverride String?

  // 1: 上线, 0: 下架
  status Int @default(1)

  // 排序权重，越小越靠前
  sortOrder Int @default(0)

  // 投放有效期（为空代表不限制）
  startAt DateTime?
  endAt   DateTime?

  // 统计与活动
  trackCode  String?
  campaignId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([targetCity, status, sortOrder])
  @@index([hotelId])
}

// 2. RoomType 表
model RoomType {
  id Int @id @default(autoincrement())

  hotelId Int
  hotel   Hotel @relation(fields: [hotelId], references: [id])

  name        String // 房型名称
  price       Int // 基础刊例价 (单位：分，建议用整数存储金额)
  bedInfo     String // 床铺信息
  images      String[] // 房型相册
  salesVolume Int      @default(0) // 销量
  sortOrder   Int      @default(0) // 排序

  capacity         Int      @default(2) // 最大容纳人数
  hasWindow        Boolean  @default(false)
  hasBreakfast     Boolean  @default(false)
  childrenFriendly Boolean  @default(false)
  tags             String[] // 房型特性标签，如 "双窗房", "智能马桶"

  inventories RoomInventory[]

  @@index([hotelId])
}

// 3. RoomInventory 表 (补全以保证关联关系成立)
model RoomInventory {
  id Int @id @default(autoincrement())

  roomTypeId Int
  roomType   RoomType @relation(fields: [roomTypeId], references: [id])

  date  DateTime // 具体日期
  price Int? // 当日特殊价格，为空则使用RoomType基础价
  quota Int      @default(10) // 当日库存

  @@unique([roomTypeId, date]) // 同一种房型在同一天只能有一条库存记录
  @@index([date, quota])
}

model User {
  id       Int     @id @default(autoincrement())
  phone    String  @unique // 核心登录账号
  password String? // 密码 (加密存储)，验证码登录时可能为空
  name     String?
  avatar   String?
  role     String  @default("USER") // 'USER' | 'ADMIN'

  // 安全字段
  failedLoginAttempts Int       @default(0) // 连续登录失败次数
  lockoutUntil        DateTime? // 账号锁定截止时间

  // 关联
  tokens UserToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// UserToken 模型：支持多端登录与 Refresh Token 管理
model UserToken {
  id        Int      @id @default(autoincrement())
  token     String // 存储 RefreshToken，不建议索引，仅用于比对
  device    String? // 设备标识，如 "iPhone 14", "PC-Chrome"
  expiresAt DateTime // 物理过期时间

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // 索引：为了加快 refreshToken 验证速度，可以给 token 加索引，
  // 但考虑到 token 较长，有些 DB 限制索引长度。
  // 也可以仅索引 userId，通过 userId + token 查找。
  @@index([userId])
}

// 枚举：b端用户角色
enum Role {
  ADMIN // 酒店管理员:审核/发布 酒店信息
  MERCHANT // 酒店商户:上传/编辑 酒店信息
}

// b端管理员用户表
model Manager {
  id            Int    @id @default(autoincrement())
  name          String @unique @db.VarChar(50) // 核心登录用户名
  password      String // 密码 (加密存储)
  role          Role   @default(MERCHANT) // 'MERCHANT' | 'ADMIN'
  contact_phone String @db.VarChar(11)
  email         String

  // 关联
  tokens ManagerToken[]

  isActive Boolean @default(true) // 账号启用/禁用状态

  hotels Hotel[] @relation("MerchantHotels")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// b端用户token模型
model ManagerToken {
  id        Int      @id @default(autoincrement())
  token     String
  expiresAt DateTime // 物理过期时间

  managerId Int
  manager   Manager @relation(fields: [managerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([managerId])
}
